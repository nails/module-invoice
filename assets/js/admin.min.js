(()=>{"use strict";window.NAILS.ADMIN.registerPlugin("nails/module-invoice","Refund",(function(t){return new class{constructor(t){this.adminController=t,this.adminController.log("Constructing").onRefreshUi((()=>{this.init()}))}init(){this.adminController.log("Looking for new items");let t=$(".js-invoice-refund:not(.js-invoice-refund--processed)");return this.adminController.log(`Found ${t.length} new items`),t.addClass("js-invoice-refund--processed").on("click",(t=>{this.adminController.log("Opening modal"),t.preventDefault(),t.stopPropagation();let e=$(t.currentTarget);this.showModal(e.data("id"),e.data("max"),e.data("max-formatted"))})),this}showModal(t,e,o){return this.$text=$("<p>").text("Please confirm refund amount and reason:"),this.$inputAmount=$("<input>").val(e/100).css({width:"100%","margin-bottom":"1em"}),this.$amountError=$("<p>").addClass("text-danger hidden").css({"margin-bottom":"1em"}),this.$inputReason=$("<textarea>").attr("placeholder","Reason for refund (optional)").css({width:"100%",margin:0}),this.$modal=$("<div>").append(this.$text).append(this.$inputAmount).append(this.$amountError).append(this.$inputReason).dialog({title:"Are you sure?",resizable:!1,draggable:!1,closeable:!1,modal:!0,buttons:{OK:()=>{let n=this.$inputAmount.val(),i=this.$inputReason.val();this.adminController.log("Clicked OK",n,i),n<=0?this.setErrorMessage("Refund amount must be greater than 0."):n>e/100?this.setErrorMessage(`Refund amount must be no greater than ${o}.`):this.clearErrorMessage().buildForm(t,n,i).submitForm()},Cancel:()=>{this.closeModal()}}}),this}submitForm(){return this.adminController.log("Submitting form"),this.$modal.dialog("close"),this.$modal=$("<div>").html("<p>Submitting refund...</p>").dialog({title:"Please wait",resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close"}),$("body").append(this.$form),this.$form.submit(),this}closeModal(){return this.adminController.log("Closing modal"),this.$modal.dialog("close"),this.$form&&(this.$form.remove(),this.$form=null),this}buildForm(t,e,o){return this.$form=$("<form>").attr({method:"POST",action:`${window.SITE_URL}admin/invoice/payment/refund/${t}`}).append($("<input>").attr({name:"amount",value:e})).append($("<input>").attr({name:"reason",value:o})).append($("<input>").attr({name:"return_to",value:window.location.href})),this}setErrorMessage(t){return this.adminController.warn(t),this.$amountError.text(t).removeClass("hidden"),this}clearErrorMessage(){return this.$amountError.addClass("hidden"),this}}(t)}))})();