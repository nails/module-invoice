(()=>{"use strict";new class{constructor(){this.$form=$("#js-invoice-main-form"),this.$btn=$("#js-invoice-pay-now"),this.$btnCancel=$("#js-invoice-cancel"),this.$form.data("validators",[]),this.$form.data("validated",!1),1===$(".js-invoice-driver-select input").length&&$("#js-invoice-main-form-payment-drivers").hide(),$(".js-invoice-driver-select input").on("click",(e=>{let t=$(e.currentTarget);$(".js-invoice-driver-select.active").removeClass("active"),t.closest(".js-invoice-driver-select").addClass("active"),$(".js-invoice-panel-payment-details").addClass("hidden"),$('.js-invoice-panel-payment-details[data-driver="'+t.data("driver")+'"]').removeClass("hidden");let a=t.data("is-redirect")?"Continue":"Pay Now";this.$btn.removeClass("btn--warning btn--disabled").text(a)})).filter(":checked").trigger("click"),$(".js-invoice-cc-num").payment("formatCardNumber"),$(".js-invoice-cc-exp").payment("formatCardExpiry"),$(".js-invoice-cc-cvc").payment("formatCardCVC"),$(".js-invoice-cc-num").on("keyup",(e=>{let t=$(e.currentTarget),a=$.trim(t.val()),i=$.payment.cardType(a),s=$(".js-invoice-cc-cvc");if(s.removeClass("amex other"),t.closest(".form__group").removeClass("has-error"),a.length>0)switch(i){case"amex":s.addClass("amex");break;default:s.addClass("other")}})).trigger("keyup"),this.$form.on("submit",(e=>{if(this.$form.data("validated"))return!0;e.preventDefault(),this.$btn.addClass("btn--working").prop("disabled",!0),this.$btnCancel.prop("disabled",!0);let t=new $.Deferred,a=!0;t.done((()=>{this.$form.data("validated",!0).submit()})).fail((e=>{$("#js-error").html(e).removeClass("hidden"),$("#js-invoice").addClass("shake"),setTimeout((()=>{$("#js-invoice").removeClass("shake")}),500),this.$btn.removeClass("btn--working").prop("disabled",!1),this.$btnCancel.prop("disabled",!1)}));try{$("#js-error").addClass("hidden");let e=$(".js-invoice-driver-select input:checked");if(0===e.length)return void t.reject("Please select a payment option");if($(".js-invoice-panel-payment-details:not(.hidden) :input").each(((e,t)=>{let i=$(t),s=i.closest(".form__group"),r=$.trim(i.val());if(s.removeClass("has-error"),i.data("is-required")&&0===r.length&&(a=!1,s.addClass("has-error")),i.data("cc-num")&&!$.payment.validateCardNumber(r)&&(a=!1,s.addClass("has-error")),i.data("cc-exp")){let e=$.payment.cardExpiryVal(r);$.payment.validateCardExpiry(e.month,e.year)||(a=!1,s.addClass("has-error"))}i.data("cc-cvc")&&!$.payment.validateCardCVC(r)&&(a=!1,s.addClass("has-error")),a||$("#js-error").html("Please check all fields").removeClass("hidden")})),!a)return void t.reject("Please correct highlighted fields");let i=this.$form.data("validators"),s=null;for(let t=0;t<i.length;t++)i[t].slug===e.val()&&(s=i[t].instance);s?s.validate(t):t.resolve()}catch(e){t.reject(e.message)}})),this.tidyLineItems()}tidyLineItems(){let e=$("#js-invoice-main-form-line-items > tbody:first-child > tr");if(e.length>3){let t=e.filter(":gt(2)");t.hide();let a=$("<tbody>"),i=$("<tr>"),s=$("<td>").attr("colspan",2),r=$("<button>").addClass("btn btn--block").html("Show "+t.length+" more items"),n=$("<button>").addClass("btn btn--block").html("Show fewer items").hide();a.append(i.append(s.append(r).append(n))),$("#js-invoice-main-form-line-items > tbody:first-child").after(a),r.on("click",(e=>(this.toggleItems(t,r,n),!1))),n.on("click",(e=>(this.toggleItems(t,r,n),!1)))}}toggleItems(e,t,a){return e.toggle(),t.toggle(),a.toggle(),!1}}})();